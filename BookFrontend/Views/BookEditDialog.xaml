<Window x:Class="book_frontend.Views.BookEditDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:converters="clr-namespace:book_frontend.Converters"
        Title="{Binding WindowTitle}"
        Height="600" Width="400"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        Style="{StaticResource MaterialDesignWindow}"
        TextElement.Foreground="{DynamicResource MaterialDesignBody}"
        TextElement.FontWeight="Regular"
        TextElement.FontSize="13"
        TextOptions.TextFormattingMode="Ideal"
        TextOptions.TextRenderingMode="Auto"
        Background="{DynamicResource MaterialDesignPaper}"
        FontFamily="{DynamicResource MaterialDesignFont}">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter" />
        <converters:EditModeToSaveTextConverter x:Key="EditModeToSaveTextConverter" />
        
        <!-- 类别CheckBox样式 -->
        <Style x:Key="CategoryCheckBoxStyle" TargetType="CheckBox" BasedOn="{StaticResource MaterialDesignCheckBox}">
            <Setter Property="Margin" Value="0,4" />
            <Setter Property="FontSize" Value="12" />
        </Style>
    </Window.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- 加载遮罩 -->
        <Grid Grid.Row="0" Grid.RowSpan="3" 
              Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
              Background="#80FFFFFF" Panel.ZIndex="999">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                           Value="0" IsIndeterminate="True" Width="50" Height="50" />
                <TextBlock Text="加载中..." Margin="0,10,0,0" HorizontalAlignment="Center" />
            </StackPanel>
        </Grid>

        <!-- 主要内容区域 -->
        <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto" 
                      IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}">
            <StackPanel>
                
                <!-- 图书标题 -->
                <TextBox materialDesign:HintAssist.Hint="图书标题"
                         materialDesign:HintAssist.IsFloating="True"
                         Text="{Binding Title, UpdateSourceTrigger=PropertyChanged}"
                         Style="{StaticResource MaterialDesignOutlinedTextBox}"
                         MaxLength="200" />

                <!-- ISBN -->
                <TextBox materialDesign:HintAssist.Hint="ISBN"
                         materialDesign:HintAssist.IsFloating="True"
                         Text="{Binding Isbn, UpdateSourceTrigger=PropertyChanged}"
                         Style="{StaticResource MaterialDesignOutlinedTextBox}"
                         MaxLength="13" />

                <!-- 出版日期 -->
                <DatePicker materialDesign:HintAssist.Hint="出版日期"
                           materialDesign:HintAssist.IsFloating="True"
                           SelectedDate="{Binding PublishedDate}"
                           Style="{StaticResource MaterialDesignOutlinedDatePicker}" />

                <!-- 库存和可用数量 -->
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="10" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    
                    <TextBox Grid.Column="0"
                             materialDesign:HintAssist.Hint="库存数量"
                             materialDesign:HintAssist.IsFloating="True"
                             Text="{Binding Stock, UpdateSourceTrigger=PropertyChanged}"
                             Style="{StaticResource MaterialDesignOutlinedTextBox}"
                             PreviewTextInput="NumberTextBox_PreviewTextInput" />
                    
                    <TextBox Grid.Column="2"
                             materialDesign:HintAssist.Hint="可用数量"
                             materialDesign:HintAssist.IsFloating="True"
                             Text="{Binding Available, UpdateSourceTrigger=PropertyChanged}"
                             Style="{StaticResource MaterialDesignOutlinedTextBox}"
                             PreviewTextInput="NumberTextBox_PreviewTextInput" />
                </Grid>

                <!-- 作者选择 -->
                <ComboBox materialDesign:HintAssist.Hint="选择作者"
                          materialDesign:HintAssist.IsFloating="True"
                          ItemsSource="{Binding Authors}"
                          SelectedValue="{Binding SelectedAuthorId}"
                          SelectedValuePath="Id"
                          DisplayMemberPath="Name"
                          Style="{StaticResource MaterialDesignOutlinedComboBox}" />

                <!-- 出版社选择 -->
                <ComboBox materialDesign:HintAssist.Hint="选择出版社"
                          materialDesign:HintAssist.IsFloating="True"
                          ItemsSource="{Binding Publishers}"
                          SelectedValue="{Binding SelectedPublisherId}"
                          SelectedValuePath="Id"
                          DisplayMemberPath="Name"
                          Style="{StaticResource MaterialDesignOutlinedComboBox}" />

                <!-- 分类选择 -->
                <GroupBox Header="选择分类" Style="{StaticResource MaterialDesignCardGroupBox}" Margin="0,8">
                    <GroupBox.HeaderTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="Tag" Height="20" Width="20" VerticalAlignment="Center" />
                                <TextBlock Margin="8,0,0,0" VerticalAlignment="Center" Style="{StaticResource MaterialDesignSubtitle1TextBlock}" Text="{Binding}" />
                            </StackPanel>
                        </DataTemplate>
                    </GroupBox.HeaderTemplate>
                    
                    <ScrollViewer MaxHeight="120" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding Categories}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <CheckBox Content="{Binding Name}"
                                              Style="{StaticResource CategoryCheckBoxStyle}"
                                              IsChecked="{Binding IsSelected, Mode=TwoWay}" />
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </GroupBox>

            </StackPanel>
        </ScrollViewer>

        <!-- 验证错误信息 -->
        <Border Grid.Row="1" 
                Background="{DynamicResource MaterialDesignValidationErrorBrush}"
                CornerRadius="4" Padding="12,8" Margin="0,8,0,0"
                Visibility="{Binding ValidationErrors, Converter={StaticResource StringToVisibilityConverter}}">
            <TextBlock Text="{Binding ValidationErrors}" 
                       Foreground="White" 
                       TextWrapping="Wrap" 
                       FontSize="12" />
        </Border>

        <!-- 按钮区域 -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" 
                    HorizontalAlignment="Right" Margin="0,16,0,0">
            
            <Button Content="取消" 
                    Command="{Binding CancelCommand}"
                    Style="{StaticResource MaterialDesignOutlinedButton}"
                    Width="80" Height="36" Margin="0,0,12,0"
                    IsEnabled="{Binding IsSaving, Converter={StaticResource InverseBooleanConverter}}" />
            
            <Button Content="{Binding IsEditMode, Converter={StaticResource EditModeToSaveTextConverter}}"
                    Command="{Binding SaveCommand}"
                    Width="80" Height="36">
                <Button.Style>
                    <Style TargetType="Button" BasedOn="{StaticResource MaterialDesignRaisedButton}">
                        <Setter Property="IsEnabled" Value="True" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsSaving}" Value="True">
                                <Setter Property="IsEnabled" Value="False" />
                                <Setter Property="Content">
                                    <Setter.Value>
                                        <StackPanel Orientation="Horizontal">
                                            <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                                                       Value="0" IsIndeterminate="True" 
                                                       Width="16" Height="16" Margin="0,0,8,0" />
                                            <TextBlock Text="保存中" VerticalAlignment="Center" />
                                        </StackPanel>
                                    </Setter.Value>
                                </Setter>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>
            
        </StackPanel>

    </Grid>
</Window>